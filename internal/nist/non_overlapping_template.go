package nist

import (
	"math"

	"gonum.org/v1/gonum/mathext"
)

// NonOverlappingTemplateTest implements the NIST Non-overlapping Template Matching test for m=9.
// It returns the minimum p-value across all templates and whether it passes at Alpha.
func NonOverlappingTemplateTest(bitstream []byte, m int) (float64, bool) {
	if m != 9 {
		return 0, false
	}

	bits := expandBits(bitstream)
	n := len(bits)
	if n < m {
		return 0, false
	}

	const (
		N = 8
		K = 5
	)

	M := n / N
	if M == 0 {
		return 0, false
	}

	lambda := float64(M-m+1) / math.Pow(2, float64(m))
	varWj := float64(M) * (1/math.Pow(2, float64(m)) - (2*float64(m)-1)/math.Pow(2, float64(2*m)))

	pi := make([]float64, K+1)
	sum := 0.0
	for i := 0; i < 2; i++ {
		pi[i] = math.Exp(-lambda + float64(i)*math.Log(lambda) - logGamma(float64(i)+1))
		sum += pi[i]
	}
	pi[0] = sum
	for i := 2; i <= K; i++ {
		pi[i-1] = math.Exp(-lambda + float64(i)*math.Log(lambda) - logGamma(float64(i)+1))
		sum += pi[i-1]
	}
	pi[K] = 1 - sum

	minP := 1.0
	for t := 0; t < len(template9); t++ {
		Wj := make([]int, N)
		for block := 0; block < N; block++ {
			wObs := 0
			for j := 0; j < M-m+1; j++ {
				match := true
				for k := 0; k < m; k++ {
					if template9[t][k] != bits[block*M+j+k] {
						match = false
						break
					}
				}
				if match {
					wObs++
					j += m - 1
				}
			}
			Wj[block] = wObs
		}

		chi2 := 0.0
		for i := 0; i < N; i++ {
			diff := (float64(Wj[i]) - lambda) / math.Sqrt(varWj)
			chi2 += diff * diff
		}

		p := mathext.GammaIncRegComp(float64(N)/2.0, chi2/2.0)
		if p < minP {
			minP = p
		}
	}

	return minP, minP >= Alpha
}

func logGamma(x float64) float64 {
	v, _ := math.Lgamma(x)
	return v
}

// template9 embeds the 148 templates for m=9 from the NIST suite.
var template9 = [][9]uint8{
	{0, 0, 0, 0, 0, 0, 0, 0, 1},
	{0, 0, 0, 0, 0, 0, 0, 1, 1},
	{0, 0, 0, 0, 0, 0, 1, 0, 1},
	{0, 0, 0, 0, 0, 0, 1, 1, 1},
	{0, 0, 0, 0, 0, 1, 0, 0, 1},
	{0, 0, 0, 0, 0, 1, 0, 1, 1},
	{0, 0, 0, 0, 0, 1, 1, 0, 1},
	{0, 0, 0, 0, 0, 1, 1, 1, 1},
	{0, 0, 0, 0, 1, 0, 0, 0, 1},
	{0, 0, 0, 0, 1, 0, 0, 1, 1},
	{0, 0, 0, 0, 1, 0, 1, 0, 1},
	{0, 0, 0, 0, 1, 0, 1, 1, 1},
	{0, 0, 0, 0, 1, 1, 0, 0, 1},
	{0, 0, 0, 0, 1, 1, 0, 1, 1},
	{0, 0, 0, 0, 1, 1, 1, 0, 1},
	{0, 0, 0, 0, 1, 1, 1, 1, 1},
	{0, 0, 0, 1, 0, 0, 0, 1, 1},
	{0, 0, 0, 1, 0, 0, 1, 0, 1},
	{0, 0, 0, 1, 0, 0, 1, 1, 1},
	{0, 0, 0, 1, 0, 1, 0, 0, 1},
	{0, 0, 0, 1, 0, 1, 0, 1, 1},
	{0, 0, 0, 1, 0, 1, 1, 0, 1},
	{0, 0, 0, 1, 0, 1, 1, 1, 1},
	{0, 0, 0, 1, 1, 0, 0, 1, 1},
	{0, 0, 0, 1, 1, 0, 1, 0, 1},
	{0, 0, 0, 1, 1, 0, 1, 1, 1},
	{0, 0, 0, 1, 1, 1, 0, 0, 1},
	{0, 0, 0, 1, 1, 1, 0, 1, 1},
	{0, 0, 0, 1, 1, 1, 1, 0, 1},
	{0, 0, 0, 1, 1, 1, 1, 1, 1},
	{0, 0, 1, 0, 0, 0, 0, 1, 1},
	{0, 0, 1, 0, 0, 0, 1, 0, 1},
	{0, 0, 1, 0, 0, 0, 1, 1, 1},
	{0, 0, 1, 0, 0, 1, 0, 1, 1},
	{0, 0, 1, 0, 0, 1, 1, 0, 1},
	{0, 0, 1, 0, 0, 1, 1, 1, 1},
	{0, 0, 1, 0, 1, 0, 0, 1, 1},
	{0, 0, 1, 0, 1, 0, 1, 0, 1},
	{0, 0, 1, 0, 1, 0, 1, 1, 1},
	{0, 0, 1, 0, 1, 1, 0, 1, 1},
	{0, 0, 1, 0, 1, 1, 1, 0, 1},
	{0, 0, 1, 0, 1, 1, 1, 1, 1},
	{0, 0, 1, 1, 0, 0, 1, 0, 1},
	{0, 0, 1, 1, 0, 0, 1, 1, 1},
	{0, 0, 1, 1, 0, 1, 0, 1, 1},
	{0, 0, 1, 1, 0, 1, 1, 0, 1},
	{0, 0, 1, 1, 0, 1, 1, 1, 1},
	{0, 0, 1, 1, 1, 0, 1, 0, 1},
	{0, 0, 1, 1, 1, 0, 1, 1, 1},
	{0, 0, 1, 1, 1, 1, 0, 1, 1},
	{0, 0, 1, 1, 1, 1, 1, 0, 1},
	{0, 0, 1, 1, 1, 1, 1, 1, 1},
	{0, 1, 0, 0, 0, 0, 0, 1, 1},
	{0, 1, 0, 0, 0, 0, 1, 1, 1},
	{0, 1, 0, 0, 0, 1, 0, 1, 1},
	{0, 1, 0, 0, 0, 1, 1, 1, 1},
	{0, 1, 0, 0, 1, 0, 0, 1, 1},
	{0, 1, 0, 0, 1, 0, 1, 1, 1},
	{0, 1, 0, 0, 1, 1, 0, 1, 1},
	{0, 1, 0, 0, 1, 1, 1, 1, 1},
	{0, 1, 0, 1, 0, 0, 0, 1, 1},
	{0, 1, 0, 1, 0, 0, 1, 1, 1},
	{0, 1, 0, 1, 0, 1, 0, 1, 1},
	{0, 1, 0, 1, 0, 1, 1, 1, 1},
	{0, 1, 0, 1, 1, 0, 0, 1, 1},
	{0, 1, 0, 1, 1, 0, 1, 1, 1},
	{0, 1, 0, 1, 1, 1, 0, 1, 1},
	{0, 1, 0, 1, 1, 1, 1, 1, 1},
	{0, 1, 1, 0, 0, 0, 1, 1, 1},
	{0, 1, 1, 0, 0, 1, 1, 1, 1},
	{0, 1, 1, 0, 1, 0, 1, 1, 1},
	{0, 1, 1, 0, 1, 1, 1, 1, 1},
	{0, 1, 1, 1, 0, 1, 1, 1, 1},
	{0, 1, 1, 1, 1, 1, 1, 1, 1},
	{1, 0, 0, 0, 0, 0, 0, 0, 0},
	{1, 0, 0, 0, 1, 0, 0, 0, 0},
	{1, 0, 0, 1, 0, 0, 0, 0, 0},
	{1, 0, 0, 1, 0, 1, 0, 0, 0},
	{1, 0, 0, 1, 1, 0, 0, 0, 0},
	{1, 0, 0, 1, 1, 1, 0, 0, 0},
	{1, 0, 1, 0, 0, 0, 0, 0, 0},
	{1, 0, 1, 0, 0, 0, 1, 0, 0},
	{1, 0, 1, 0, 0, 1, 0, 0, 0},
	{1, 0, 1, 0, 0, 1, 1, 0, 0},
	{1, 0, 1, 0, 1, 0, 0, 0, 0},
	{1, 0, 1, 0, 1, 0, 1, 0, 0},
	{1, 0, 1, 0, 1, 1, 0, 0, 0},
	{1, 0, 1, 0, 1, 1, 1, 0, 0},
	{1, 0, 1, 1, 0, 0, 0, 0, 0},
	{1, 0, 1, 1, 0, 0, 1, 0, 0},
	{1, 0, 1, 1, 0, 1, 0, 0, 0},
	{1, 0, 1, 1, 0, 1, 1, 0, 0},
	{1, 0, 1, 1, 1, 0, 0, 0, 0},
	{1, 0, 1, 1, 1, 0, 1, 0, 0},
	{1, 0, 1, 1, 1, 1, 0, 0, 0},
	{1, 0, 1, 1, 1, 1, 1, 0, 0},
	{1, 1, 0, 0, 0, 0, 0, 0, 0},
	{1, 1, 0, 0, 0, 0, 0, 1, 0},
	{1, 1, 0, 0, 0, 0, 1, 0, 0},
	{1, 1, 0, 0, 0, 1, 0, 0, 0},
	{1, 1, 0, 0, 0, 1, 0, 1, 0},
	{1, 1, 0, 0, 1, 0, 0, 0, 0},
	{1, 1, 0, 0, 1, 0, 0, 1, 0},
	{1, 1, 0, 0, 1, 0, 1, 0, 0},
	{1, 1, 0, 0, 1, 1, 0, 0, 0},
	{1, 1, 0, 0, 1, 1, 0, 1, 0},
	{1, 1, 0, 1, 0, 0, 0, 0, 0},
	{1, 1, 0, 1, 0, 0, 0, 1, 0},
	{1, 1, 0, 1, 0, 0, 1, 0, 0},
	{1, 1, 0, 1, 0, 1, 0, 0, 0},
	{1, 1, 0, 1, 0, 1, 0, 1, 0},
	{1, 1, 0, 1, 0, 1, 1, 0, 0},
	{1, 1, 0, 1, 1, 0, 0, 0, 0},
	{1, 1, 0, 1, 1, 0, 0, 1, 0},
	{1, 1, 0, 1, 1, 0, 1, 0, 0},
	{1, 1, 0, 1, 1, 1, 0, 0, 0},
	{1, 1, 0, 1, 1, 1, 0, 1, 0},
	{1, 1, 0, 1, 1, 1, 1, 0, 0},
	{1, 1, 1, 0, 0, 0, 0, 0, 0},
	{1, 1, 1, 0, 0, 0, 0, 1, 0},
	{1, 1, 1, 0, 0, 0, 1, 0, 0},
	{1, 1, 1, 0, 0, 0, 1, 1, 0},
	{1, 1, 1, 0, 0, 1, 0, 0, 0},
	{1, 1, 1, 0, 0, 1, 0, 1, 0},
	{1, 1, 1, 0, 0, 1, 1, 0, 0},
	{1, 1, 1, 0, 1, 0, 0, 0, 0},
	{1, 1, 1, 0, 1, 0, 0, 1, 0},
	{1, 1, 1, 0, 1, 0, 1, 0, 0},
	{1, 1, 1, 0, 1, 0, 1, 1, 0},
	{1, 1, 1, 0, 1, 1, 0, 0, 0},
	{1, 1, 1, 0, 1, 1, 0, 1, 0},
	{1, 1, 1, 0, 1, 1, 1, 0, 0},
	{1, 1, 1, 1, 0, 0, 0, 0, 0},
	{1, 1, 1, 1, 0, 0, 0, 1, 0},
	{1, 1, 1, 1, 0, 0, 1, 0, 0},
	{1, 1, 1, 1, 0, 0, 1, 1, 0},
	{1, 1, 1, 1, 0, 1, 0, 0, 0},
	{1, 1, 1, 1, 0, 1, 0, 1, 0},
	{1, 1, 1, 1, 0, 1, 1, 0, 0},
	{1, 1, 1, 1, 0, 1, 1, 1, 0},
	{1, 1, 1, 1, 1, 0, 0, 0, 0},
	{1, 1, 1, 1, 1, 0, 0, 1, 0},
	{1, 1, 1, 1, 1, 0, 1, 0, 0},
	{1, 1, 1, 1, 1, 0, 1, 1, 0},
	{1, 1, 1, 1, 1, 1, 0, 0, 0},
	{1, 1, 1, 1, 1, 1, 0, 1, 0},
	{1, 1, 1, 1, 1, 1, 1, 0, 0},
	{1, 1, 1, 1, 1, 1, 1, 1, 0},
}
