syntax = "proto3";

package nist.v1;

option go_package = "github.com/AmmannChristian/nist-sp800-22-rev1a/pkg/pb;nistv1";

// NIST SP 800-22 Statistical Test Suite Service
service NISTTestService {
  // RunTests executes all 15 NIST statistical tests on the provided bitstream
  rpc RunTests(TestRequest) returns (TestResponse);
  
  // HealthCheck returns service health status
  rpc HealthCheck(HealthRequest) returns (HealthResponse);
}

// TestRequest contains the bitstream and optional configuration
message TestRequest {
  // Raw bitstream as bytes (minimum 1M bits = 125,000 bytes)
  bytes bitstream = 1;
  
  // Optional test configuration parameters
  optional TestConfig config = 2;
}

// TestConfig allows customization of test parameters
message TestConfig {
  // Block Frequency Test - block length M (default: 128)
  int32 block_frequency_block_length = 1;
  
  // Non-Overlapping Template Test - block length m (default: 9)
  int32 non_overlapping_template_block_length = 2;
  
  // Overlapping Template Test - block length m (default: 9)
  int32 overlapping_template_block_length = 3;
  
  // Approximate Entropy Test - block length m (default: 10)
  int32 approximate_entropy_block_length = 4;
  
  // Serial Test - block length m (default: 16)
  int32 serial_block_length = 5;
  
  // Linear Complexity Test - sequence length M (default: 500)
  int32 linear_complexity_sequence_length = 6;
}

// TestResponse contains results from all 15 tests
message TestResponse {
  // ISO 8601 timestamp when tests were executed
  string timestamp = 1;
  
  // Number of bits in the input sample
  int32 sample_size_bits = 2;
  
  // Overall pass rate (0.0 - 1.0) - ONLY for implemented tests
  // Formula: (passed tests) / (tests_run)
  double overall_pass_rate = 3;
  
  // P-value uniformity chi-squared test result (only for implemented tests)
  double p_value_uniformity_chi2 = 4;
  
  // Individual test results (15 tests)
  repeated TestResult tests = 5;
  
  // Total execution time in milliseconds
  int64 execution_time_ms = 6;
  
  // TRANSPARENCY: Show implementation status
  int32 tests_run = 7;        // Number of tests actually executed (not skipped)
  int32 tests_skipped = 8;     // Number of tests not yet implemented
  int32 tests_total = 9;       // Always 15 for NIST SP 800-22
  
  // COMPLIANCE: Is this a full NIST SP 800-22 test run?
  bool nist_compliant = 10;    // true only if tests_run == tests_total
}

// TestResult represents the outcome of a single statistical test
message TestResult {
  // Test name (e.g., "frequency_monobit")
  string name = 1;
  
  // P-value from the test (0.0 - 1.0)
  double p_value = 2;
  
  // Whether the test passed (p_value > 0.01)
  bool passed = 3;
  
  // Proportion metric (for multi-run tests, optional)
  optional double proportion = 4;
  
  // Warning message if test couldn't complete normally
  optional string warning = 5;
}

// HealthRequest is empty for now
message HealthRequest {}

// HealthResponse indicates service status
message HealthResponse {
  // Whether the service is healthy
  bool healthy = 1;
  
  // Service version
  string version = 2;
  
  // Optional status message
  optional string message = 3;
}
